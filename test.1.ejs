<!DOCTYPE html>
<html>
<head>
	<title>Markit On Demand Lookup API Demo</title>
	<link rel="stylesheet" href="http://markitondemand.github.io/DataApis/Resources/bootstrap/bootstrap-2.3.2.css" />
	<link rel="stylesheet" href="http://markitondemand.github.io/DataApis/LookupSample/resources/demo.css" />
</head>
<body>
<div class="container web">
	<div class="row content">
		<div class="span12">
			<div id="chartDemoContainer" style="height: 500px; min-width: 500px; margin-bottom: 30px;"></div>
			<form class="well form-inline">
				<label>Search for a stock:</label>
				<input type="text" id="symbolsearch" class="input-" placeholder="Enter company name or symbol">
				<span class="help-inline hide"><img src="http://markitondemand.github.io/DataApis/LookupSample/resources/spinner.gif" align="absmiddle" /> loading...</span>
				<span class="help-inline hide label label-info"></span>
			</form>
			<div id="stockButtons">
				<div class="btn btn-info" role="button">GE <a class="stock" id="GE">X</a></div>
			</div>
		</div>
	</div>
</div>

<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
<script type="text/javascript" src="http://markitondemand.github.io/DataApis/InteractiveChartSample/resources/purl.js"></script>
<script src="https://code.highcharts.com/stock/highstock.js"></script>
<script src="https://code.highcharts.com/stock/modules/exporting.js"></script>
<script type="text/javascript">

var seriesOptions = [];
/** 
 * Version 2.0
 */
var Markit = {};
/**
 * Define the InteractiveChartApi.
 * First argument is symbol (string) for the quote. Examples: AAPL, MSFT, JNJ, GOOG.
 * Second argument is duration (int) for how many days of history to retrieve.
 */
Markit.InteractiveChartApi = function(symbol,duration){
    this.symbol = symbol.toUpperCase();
    this.duration = duration;
    this.PlotChart();
};

Markit.InteractiveChartApi.prototype.PlotChart = function(){
    
    var params = {
        parameters: JSON.stringify( this.getInputParams() )
    }

    //Make JSON request for timeseries data
    $.ajax({
        beforeSend:function(){
            $("#chartDemoContainer").text("Loading chart...");
        },
        data: params,
        url: "http://dev.markitondemand.com/Api/v2/InteractiveChart/jsonp",
        dataType: "jsonp",
        context: this,
        success: function(json){
            //Catch errors
            if (!json || json.Message){
                console.error("Error: ", json.Message);
                return;
            }
            this.render(json);
        },
        error: function(response,txtStatus){
            console.log(response,txtStatus)
        }
    });
};

Markit.InteractiveChartApi.prototype.getInputParams = function(){
    return {  
        Normalized: false,
        NumberOfDays: this.duration,
        DataPeriod: "Day",
        Elements: [
            {
                Symbol: this.symbol,
                Type: "price",
                Params: ["ohlc"] //ohlc, c = close only
            }
        ]
        //,LabelPeriod: 'Week',
        //LabelInterval: 1
    }
};

Markit.InteractiveChartApi.prototype._fixDate = function(dateIn) {
    var dat = new Date(dateIn);
    return Date.UTC(dat.getFullYear(), dat.getMonth(), dat.getDate());
};

Markit.InteractiveChartApi.prototype._getOHLC = function(json) {
    var dates = json.Dates || [];
    var elements = json.Elements || [];
    var chartSeries = [];

    if (elements[0]){

        for (var i = 0, datLen = dates.length; i < datLen; i++) {
            var dat = this._fixDate( dates[i] );
            var pointData = [
                dat,
                elements[0].DataSeries['open'].values[i],
                elements[0].DataSeries['high'].values[i],
                elements[0].DataSeries['low'].values[i],
                elements[0].DataSeries['close'].values[i]
            ];
            chartSeries.push( pointData );
        };
    }
    return chartSeries;
};

Markit.InteractiveChartApi.prototype.render = function(data) {
    //console.log(data)
    // split the data set into ohlc and volume
    var ohlc = this._getOHLC(data);
    // set the allowed units for data grouping
    var groupingUnits = [[
        'week',                         // unit name
        [1]                             // allowed multiples
    ], [
        'month',
        [1, 2, 3, 4, 6]
    ]];
    seriesOptions.push({name: this.symbol,data: ohlc});
    // create the chart
    $('#chartDemoContainer').highcharts('StockChart', {
        
        rangeSelector: {
            selected: 1
            //enabled: false
        },

        title: {
            text: 'Stocks'
        },

        yAxis: [{
            title: {
                text: 'OHLC'
            }
        }],
        
        series: seriesOptions,
        credits: {
            enabled:false
        }
    });
};

</script>
<script type="text/javascript">

	$(function() {

		$("#symbolsearch")
			.focus()
			.autocomplete({
				source: function(request,response) {
					$.ajax({
						beforeSend: function(){ 
							$("span.help-inline").show();
							$("span.label-info").empty().hide();
						},
						url: "http://dev.markitondemand.com/api/v2/Lookup/jsonp",
						dataType: "jsonp",
						data: {
							input: request.term
						},
						success: function(data) {
							response( $.map(data, function(item) {
								return {
									label: item.Name + " (" +item.Exchange+ ")",
									value: item.Symbol
								}
							}));
							$("span.help-inline").hide();
						}
					});
				},
				minLength: 0,
				select: function( event, ui ) {
					//console.log(ui.item);
					$("span.label-info").html("You selected " + ui.item.label).fadeIn("fast");
					console.log(ui.item);
					var tempsym = $.url().param('symbol') || 'AAPL';
					var tempdur = $.url().param('duration') || 3650;
					new Markit.InteractiveChartApi(tempsym, tempdur);
					$('#stockButtons').append('<div class="btn btn-info" role="button">AAPL <a class="stock" id="AAPL">X</a></div>');
				}
			})
		;
	});

</script>
<script type="text/javascript">

	$(function(){

		var sym = $.url().param('symbol') || 'GE';
		var dur = $.url().param('duration') || 3650;
		
		new Markit.InteractiveChartApi(sym, dur);
	});
	
	$('body').on('click', '.stock', function() {
        var stockValue = $(this).attr("id");
        var chart = $('#chartDemoContainer').highcharts();
        for(var i = 0; i < chart.series.length; i++) {
        	if(chart.series[i].name === stockValue){
        		chart.series[i].remove();
        		break;
        	}
        }
        for(var j = 0; j < seriesOptions.length; j++) {
        	if(seriesOptions[j].name === stockValue) {
        		seriesOptions.splice(j, 1);
        		break;
        	}
        }
        console.log(seriesOptions);
	});

</script>
</body>
</html>